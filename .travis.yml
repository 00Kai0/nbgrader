language: python
python:
  - 2.7
  - 3.4
env:
  matrix:
    - GROUP=docs
    - GROUP=js
    - GROUP=
  global:
    - secure: P1srvJIQ+vFCd7jTuxqhp07JF+wqWtWkCYDcrT8hHZMgsy0wjNTkXP3h5+7dboYOjhmJcy2GX3tsdIzmcSm6/NttMqHhK1WL+dCgFgLijsyUzyOEsAxGi/E4w9xxX5WRRQdFniOgNVpv9bzrD0ngpUCXdQnutc+52mCDAS+hYMk=
before_install:
  # Pierre Carrier's PPA for PhantomJS and CasperJS
  - time sudo add-apt-repository -y ppa:pcarrier/ppa
  - sudo apt-get update
  - cd ~
  - git clone --recursive https://github.com/ipython/ipython.git
  - cd -
install:
  - sudo apt-get install pandoc casperjs libzmq3-dev
  # pin tornado < 4 for js tests while phantom is on super old webkit
  - if [[ $GROUP == 'js' ]]; then pip install 'tornado<4'; fi
  - cd ~/ipython && git submodule update && pip install -e ".[notebook]" && cd -
  - pip install -r requirements.txt
  - pip install nose requests!=2.4.2 invoke
  - python setup.py install
  - if [[ $GROUP == 'js' ]]; then cp nbextensions/* $(ipython locate)/nbextensions/; fi
script:
  |
  if [[ $GROUP != 'docs' ]]; then 
    ./scripts/runtests $GROUP
  else
    git config user.name "${GIT_NAME}"
    git config user.email "${GIT_EMAIL}"
    invoke docs --branch=$(git rev-parse --abbrev-ref HEAD)
  fi
after_success:
  |
  if [[ $TRAVIS_PULL_REQUEST == false && $TRAVIS_PYTHON_VERSION == 3.4 && $GROUP == 'docs' ]]; then
    git config credential.helper "store --file=.git/credentials"
    echo "https://${GH_TOKEN}:@github.com" > .git/credentials
    git remote set-url --push origin https://github.com/jupyter/nbgrader.git
    git push origin docs:docs
    rm .git/credentials
  fi
